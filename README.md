# RDP Sessions Report

Скрипт `fetch_rdp_sessions.py` формирует отчёт по времени работы пользователей через RDP на серверах Windows, используя события из журнала Microsoft-Windows-TerminalServices-LocalSessionManager/Operational.

## Требования
- Python 3.7+
- Poetry (для управления зависимостями)

## Установка и настройка

### 1. Установка Poetry
```bash
# Windows (PowerShell)
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -

# Или через pip
pip install poetry
```

### 2. Клонирование и настройка проекта
```bash
git clone <repository-url>
cd rdp-sessions-report
poetry install
```

### 3. Настройка переменных окружения
Создайте файл `.env` в директории проекта:

```
RDP_LOG_USERNAME=имя_пользователя
RDP_LOG_PASSWORD=пароль
RDP_LOG_DOMAIN=домен (если требуется, иначе оставить пустым)
RDP_SERVERS=server1,server2
```

**Описание переменных:**
- `RDP_LOG_USERNAME` - имя пользователя для подключения к серверам
- `RDP_LOG_PASSWORD` - пароль пользователя
- `RDP_LOG_DOMAIN` - домен (если требуется, иначе оставить пустым)
- `RDP_SERVERS` - список серверов через запятую (например: `server1,server2,server3`)

## Использование

### 1. Активация виртуального окружения
```bash
poetry shell
```

### 2. Настройка параметров
В файле `fetch_rdp_sessions.py` задайте:

#### Для отчёта за одну дату:
```python
single_date_mode = True
report_date = "2025-07-07"  # YYYY-MM-DD
```

#### Для отчёта за диапазон дат:
```python
single_date_mode = False
start_date = "2025-07-01"  # начальная дата
end_date = "2025-07-07"    # конечная дата
```

**Примечание:** Список серверов настраивается в файле `.env` через переменную `RDP_SERVERS`.

### 3. Запуск скрипта
```bash
poetry run python fetch_rdp_sessions.py
```

### 4. Проверка доступных дат
Для проверки доступных дат в журналах:
```bash
poetry run python check_available_dates.py
```

### 5. Пример отчёта
```
Дата;UserId;Логин;Сервер входа;Сервер выхода;Вход;Выход;Длительность сессии;Итого за день
2025-07-07;136;user1;server1;server1;08:09:57;19:42:21;11:32:24
2025-07-07;136;user1;server2;server2;14:30:00;17:45:30;3:15:30
2025-07-07;136;user1;ВСЕ СЕРВЕРЫ;;;Итого за день:;14:47:54
```

## Структура отчёта
- **Дата** - дата отчёта
- **UserId** - ID пользователя
- **Логин** - имя пользователя
- **Сервер входа** - сервер, с которого пользователь вошёл
- **Сервер выхода** - сервер, с которого пользователь вышел
- **Вход/Выход** - время сессий
- **Длительность** - время работы
- **Итого за день** - общее время работы пользователя на всех серверах

## Временные ограничения

### Доступные периоды:
- **30 дней** - гарантированно доступны данные
- **90 дней** - обычно доступны (зависит от настроек журнала)
- **До 1 года** - может потребоваться настройка политики очистки

### Факторы, влияющие на доступность:
1. **Настройки журнала Windows** - по умолчанию 90 дней
2. **Размер журнала** - ограничен дисковым пространством
3. **Политика очистки** - автоматическое удаление старых событий
4. **Количество событий** - влияет на производительность запросов

### Рекомендации:
- **Для ежедневных отчётов** - проблем нет
- **Для недельных отчётов** - рекомендуется использовать диапазон дат
- **Для месячных отчётов** - проверьте доступность через `check_available_dates.py`
- **Для квартальных отчётов** - может потребоваться настройка журнала

## Разработка

### Установка зависимостей для разработки
```bash
poetry install --with dev
```

### Форматирование кода
```bash
poetry run black .
```

### Проверка стиля кода
```bash
poetry run flake8 .
```

### Запуск тестов
```bash
poetry run pytest
```

## Примечания
- Скрипт работает через WinRM (должен быть разрешён на всех серверах).
- Для получения отчёта за другую дату измените переменную `report_date`.
- Если потребуется выгрузка за диапазон дат или автоматизация — доработайте цикл по датам.
- Скрипт собирает данные со всех указанных серверов и объединяет их в один отчёт, сгруппированный по пользователям.
- Если пользователь работал на разных серверах, каждая сессия показывается отдельно, а в конце выводится общий итог.
- Используйте `check_available_dates.py` для проверки доступных дат перед запросом больших периодов. 